[
  {
    "objectID": "posts/finetuning-egyptian-arabic-translator/notebook.html",
    "href": "posts/finetuning-egyptian-arabic-translator/notebook.html",
    "title": "Finetuing an Egyptian Arabic Translator",
    "section": "",
    "text": "Introduction\nThis blog post contains a walkthrough of a recent project I worked on to dive deeper into fine-tuning as part of the Mastering LLMs: A Conference For Developers & Data Scientists course by Hamel Husain and Dan Becker.\nWith the abundance of instruction tuning datasets following the release of open source models, many efforts have been made to curate and translate these datasets into Arabic. Unfortunately, Egyptian Arabic dialect is almost forgotten in these attempts, and this project aims to change that.\nCurrently, you can use flagship models from OpenAI or Anthropic to translate from English to Egyptian Arabic with excellent results. However, the high cost makes it impractical for individuals to translate the available open source datasets.\nThis project’s outcome is a translator built using an open source model, making it easier to translate large amounts of data and integrating the Egyptian Arabic dialect into open source models for instruction fine-tuning.\n\n\nOutline\n\nThe blogpost will be split into 4 parts:\n\nCreating finetuning data using GPT-4o\nPreparing the dataset for finetuning\nFinetuning Llama 3 8B using Axolotl\nComparing the results before and after finetuning\n\n\n\n\nCreating finetuing data using GPT-4o\nTo fine-tune a translation model, we need translation pairs between English and Egyptian Arabic.\nSince my goal was to use this model for translating instruction and conversation datasets, I needed a starting point.\nI decided to use the OpenAssistant dataset, selecting a random sample of messages rather than entire conversations. In future iterations of this project, I plan to diversify the sources of translation data, using different datasets like Alpaca or even Wikipedia articles.\n\nfrom datasets import load_dataset\nimport pandas as pd\n\n# Load open assistant 2 dataset\nds = load_dataset(\"OpenAssistant/oasst2\")\n\n# Filter for only english\nenglish_ds = ds.filter(lambda x: x[\"lang\"] == \"en\")[\"train\"]\n\n# Visual check\nprint(english_ds[\"text\"][1])\n\nYes, it's possible to fix runny mayonnaise! The most common reason for mayonnaise becoming runny is because the oil was added too quickly or the egg yolk wasn't emulsified properly. Here are some steps you can take to fix it:\n\n1. Separate another egg yolk and place it in a clean, dry bowl.\n2. Slowly add the runny mayonnaise to the egg yolk while whisking vigorously.\n3. Once all the runny mayonnaise has been added, continue whisking until the mixture has emulsified and thickened.\n4. If the mayonnaise is still too runny, you can add another egg yolk and repeat the process.\n\nIf the mayonnaise still won't thicken, you can try adding a small amount of dijon mustard or vinegar to the mixture, which can act as emulsifiers and help stabilize the mayonnaise. It's important to add these ingredients slowly and in small amounts to avoid over-thinning the mixture.\n\n\nWhile testing GPT-4o for translating from English to Egyptian Arabic, I noticed that direct translations often resulted in poor quality. To mitigate this, I found that translating first into Modern Standard Arabic and then into Egyptian Arabic produced much better results. Therefore, I used GPT-4o to translate each sentence or paragraph into Arabic first, and then into Egyptian Arabic.\nHere’s the prompt I used:\n\nSYSTEM_PROMPT = \"\"\"You are an fluent speaker and expert translator for English, Arabic and Egyptian Arabic. \\\nYour task is to translate text from English into Egyptian Arabic dialect.\n\n# Steps to Achieve the Best Results:\nStep 1: Translate the text from English into Modern Standard Arabic.\nStep 2: Translate the text from Modern Standard Arabic into Egyptian dialect.\n\n# Adhere to the Following Instructions:\n1. **Always follow the steps presented above.**\n2. **Output the two translations as keys in a JSON object:**\n    - \"ar\" for the Modern Standard Arabic translation.\n    - \"eg\" for the Egyptian Arabic dialect translation.\n3. **You may change the order of sentences when necessary** to better mimic the style of Arabic and Egyptian dialect.\n4. **Your translation should not be literal**; it should capture the essence of the text.\n5. **Translate specific English terminologies (e.g., science, computer science, biology) or entities \\\n(e.g., movies, series, poems, names, programming languages)**, but always keep their original English form within parentheses.\n6. **If the text contains code or is entirely code**, do not translate the code part; write it as it is.\"\"\"\n\nAnd here, you can see a sample of GPT-4o’s translation using that prompt.\n\nfrom dotenv import load_dotenv\nfrom openai import OpenAI\n\nimport os\n\nload_dotenv()\n\nclient = OpenAI(api_key=os.getenv(\"OPENAI_API_KEY\"))\n\nresponse = client.chat.completions.create(\n  model=\"gpt-4o\",\n  messages=[{\"role\": \"system\", \"content\": SYSTEM_PROMPT}, \n            {\"role\": \"user\", \"content\": f\"Translate the following text:\\n{english_ds[\"text\"][1]}\"}],\n  temperature=1,\n  max_tokens=512,\n  top_p=1\n)\n\nprint(response.choices[0].message.content)\n\n```json\n{\n  \"ar\": \"نعم، من الممكن إصلاح المايونيز السائل! السبب الأكثر شيوعًا لأن يصبح المايونيز سائلاً هو أن الزيت أضيف بسرعة كبيرة أو أن صفار البيض لم يتم استحلابه بشكل صحيح. إليك بعض الخطوات التي يمكنك اتباعها لإصلاحه:\n\n1. افصل صفار بيضة أخرى وضعه في وعاء نظيف وجاف.\n2. أضف المايونيز السائل تدريجياً إلى صفار البيض مع الخفق بقوة.\n3. بمجرد إضافة كل المايونيز السائل، استمر في الخفق حتى يتم استحلاب الخليط ويثخن.\n4. إذا كان المايونيز لا يزال سائلاً جدًا، يمكنك إضافة صفار بيضة أخرى وتكرار العملية.\n\nإذا لم يثخن المايونيز بعد، يمكنك محاولة إضافة كمية صغيرة من خردل (dijon) أو خل إلى الخليط، حيث يمكن أن تعمل كمستحلبات وتساعد في تثبيت المايونيز. من المهم إضافة هذه المكونات ببطء وبكميات صغيرة لتجنب تخفيف الخليط بشكل زائد.\",\n  \n  \"eg\": \"أيوه، ممكن تصلح المايونيز السايل! أكتر سبب بيخلي المايونيز يبقى سايل هو إن الزيت أضيف بسرعة أو إن صفار البيض مش متجانس كويس. دي شوية خطوات ممكن تعملها لتصلح المشكلة:\n\n1. اعزل صفار بيضة تانية وحطه في طبق نضيف وجاف.\n2. أضف المايونيز السايل تدريجياً لصفار البيض وأنت بتخفق بكل قوة.\n3. لما تضيف كل المايونيز السايل، كمل في الخفق لحد ما الخليط يتجانس ويكثف.\n4. لو المايونيز لسه سايل جداً، ممكن تضيف صفار بيضة تانية وتكرر العملية.\n\nلو المايونيز لسه مش عايز يثخن، جرب تضيف شوية من خردل (dijon) أو خل للخليط، دول بيساعدوا في تجانس المايونيز. المهم تضيف المكونات دي ببطء وبكميات صغيرة عشان ما تدفيش الخليط.\" \n}\n```\n\n\nAfter developing the prompt, I utilized the OpenAI batch API to translate a sample of 10K messages from the dataset. The process involved three main steps:\n\nGenerating 10 separate JSONL files, each containing prompts for translating different messages.\nSubmitting these JSONL files to OpenAI’s batch API.\nDownloading the results.\n\nHere’s the code snippet that accomplishes this:\n\n\nCode\nimport json\nfrom tqdm import tqdm\n\n\ndef generate_jsonl(filename, texts):\n    \"\"\"\n    Generate a JSONL file with the specified filename\n    \"\"\"\n\n    # Write jsonl file\n    with open(filename, 'w') as file:\n        for index in tqdm(range(0, len(texts)), desc=\"Generating JSONL File\"):\n            text = texts[index]\n            request = {\n                \"custom_id\": str(index),\n                \"method\": \"POST\",\n                \"url\": \"/v1/chat/completions\",\n                \"body\": {\n                    \"model\": \"gpt-4o\",\n                    \"messages\": [\n                        {\"role\": \"system\", \"content\": SYSTEM_PROMPT},\n                        {\"role\": \"user\", \"content\": f\"Translate the following text:\\n{text}\"}\n                    ],\n                    \"temperature\": 1,\n                    \"top_p\": 1,\n                    \"max_tokens\": 2048,\n                }\n            }\n            file.write(json.dumps(request) + '\\n')\n\nbatch_ids = {}\n\nfor start in range(0, 10000, 1000):\n    end = start + 1000\n    english_ds_sample = english_ds.shuffle(seed=42)[\"train\"].select(range(start, end))\n    english_ds_sample_df = english_ds_sample.to_pandas()\n\n    if (start, end-1) in batch_ids.keys():\n        batch_status = client.batches.retrieve(batch_ids[(start, end-1)]).status\n        if batch_status != 'failed':\n            continue\n\n    print(f'Creating batch for ({start}, {end-1})')\n\n    batch_input_fn = f'batch_api_input_{start}_{end-1}.jsonl'\n    generate_jsonl(batch_input_fn, english_ds_sample_df[\"text\"].tolist())\n    \n    batch_input_file = client.files.create(\n        file=open(batch_input_fn, \"rb\"),\n        purpose=\"batch\"\n    )\n\n    batch_input_file_id = batch_input_file.id\n\n    batch = client.batches.create(\n        input_file_id=batch_input_file_id,\n        endpoint=\"/v1/chat/completions\",\n        completion_window=\"24h\",\n        metadata={\n        \"description\": f\"OpenAssistant 1K ({start}, {end-1}) sample translation\"\n        }\n    )\n\n    batch_ids[(start, end-1)] = batch.id\n\n\n# To run this part, you have to wait for some time to check that all batches are completed\nfor r, batch_id in batch_ids.items():\n    start, end = r\n    print(f'Downloading ({start}, {end}) batch outputs')\n    content = client.files.content(client.batches.retrieve(batch_id).output_file_id)\n    content.write_to_file(f\"batch_output_{start}_{end}.jsonl\")\n\n\n\n\nPreparing the dataset for finetuning\nThe output from the previous step consists of separate JSONL files, each containing the output for a specific batch. To proceed with fine-tuning, we need to process this output into a suitable format.\nHere’s a look at the batch inputs and outputs:\n\nwith open('data/batch_api_input_0_999.jsonl') as f:\n    english = [json.loads(line) for line in f]\n\nwith open('data/batch_output_0_999.jsonl') as f:\n    translations = [json.loads(line) for line in f]\n\nenglish[:1], translations[:1]\n\n([{'custom_id': '0',\n   'method': 'POST',\n   'url': '/v1/chat/completions',\n   'body': {'model': 'gpt-4o',\n    'messages': [{'role': 'system',\n      'content': 'You are an fluent speaker and expert translator for English, Arabic and Egyptian Arabic. Your task is to translate text from English into Egyptian Arabic dialect.\\n\\n# Steps to Achieve the Best Results:\\nStep 1: Translate the text from English into Modern Standard Arabic.\\nStep 2: Translate the text from Modern Standard Arabic into Egyptian dialect.\\n\\n# Adhere to the Following Instructions:\\n1. **Always follow the steps presented above.**\\n2. **Output the two translations as keys in a JSON object:**\\n    - \"ar\" for the Modern Standard Arabic translation.\\n    - \"eg\" for the Egyptian Arabic dialect translation.\\n3. **You may change the order of sentences when necessary** to better mimic the style of Arabic and Egyptian dialect.\\n4. **Your translation should not be literal**; it should capture the essence of the text.\\n5. **Translate specific English terminologies (e.g., science, computer science, biology) or entities (e.g., movies, series, poems, names, programming languages)**, but always keep their original English form within parentheses.\\n6. **If the text contains code or is entirely code**, do not translate the code part; write it as it is.'},\n     {'role': 'user',\n      'content': \"Translate the following text:\\nThanks for the list! I'm especially interested in how these women overcame obstacles in their lives. Are there any resources you can recommend for learning more about their stories?\"}],\n    'temperature': 1,\n    'top_p': 1,\n    'max_tokens': 2048}}],\n [{'id': 'batch_req_tuugwkbZhxWZ7fKL5YRQWvHP',\n   'custom_id': '0',\n   'response': {'status_code': 200,\n    'request_id': '161ad42423c0ecf010ce879f31e50e5d',\n    'body': {'id': 'chatcmpl-9b76MvbpkO4dfI8dQLWOPFEPo1dZC',\n     'object': 'chat.completion',\n     'created': 1718632462,\n     'model': 'gpt-4o-2024-05-13',\n     'choices': [{'index': 0,\n       'message': {'role': 'assistant',\n        'content': '```json\\n{\\n  \"msa\": \"شكرًا على القائمة! أنا مهتم بشكل خاص في كيفية تغلب هؤلاء النساء على العقبات في حياتهن. هل هناك أي موارد يمكنك أن توصي بها لمعرفة المزيد عن قصصهن؟\",\\n  \"ea\": \"شكرًا على القائمة! أنا مهتمة بالذات أعرف إزاي الستات دول قدروا يعدوا العقبات اللي في حياتهم. في مصادر تنصحني بيها عشان أتعرف أكتر على حكاويهم؟\"\\n}\\n```'},\n       'logprobs': None,\n       'finish_reason': 'stop'}],\n     'usage': {'prompt_tokens': 290,\n      'completion_tokens': 109,\n      'total_tokens': 399},\n     'system_fingerprint': 'fp_319be4768e'}},\n   'error': None}])\n\n\nFor each sample in these batch files, we need to extract the English text used for translation and the JSON output from GPT-4o, then parse out the Arabic and Egyptian Arabic translations.\nFor each triplet, I create 6 translation pairs:\n\nArabic to English\nEgyptian Arabic to English\nEnglish to Arabic\nEgyptian Arabic to Arabic\nEnglish to Egyptian Arabic\nArabic to Egyptian Arabic\n\nThe main purpose of the model was to translate from English to Egyptian Arabic, but I thought that including the back translation could enhance the model’s capabilities. Additionally, it creates a bridge for translating from English to Arabic and from Arabic to Egyptian Arabic, which proved effective with GPT-4o.\nHere is the updated code to handle this process:\n\n\nCode\nimport glob\n\ndef convert_text_to_dict(text):\n    # Remove the '```json' and '```' delimiters\n    cleaned_text = text.replace('```json\\n', '').replace('```', '').strip()\n    \n    # Convert the cleaned text into a dictionary, ensuring it does not error out\n    try:\n        result_dict = json.loads(cleaned_text, strict=False)\n    except json.JSONDecodeError as e:\n        print(\"JSON Decode Error:\", e)\n        # Attempt to clean the text further or handle specific issues\n        cleaned_text = cleaned_text.replace('\\n', '\\\\n').replace('\\\\\"', '\"').replace('\\\\\\'', \"'\")\n        try:\n            result_dict = json.loads(cleaned_text, strict=False)\n        except json.JSONDecodeError as e:\n            print(\"JSON Decode Error after further cleaning:\", e)\n            return None\n    \n    return result_dict\n\n\ninput_files = sorted(glob.glob(\"data/batch_api_input*\"))\noutput_files = sorted(glob.glob(\"data/batch_output*\"))\n\nenglish = []\ntranslations = []\n\nfor input_file in input_files:\n    with open(input_file) as f:\n        english.extend([json.loads(line) for line in f])\n\nfor output_file in output_files:\n    with open(output_file) as f:\n        translations.extend([json.loads(line) for line in f])\n\n\nThis snippet loads the batch inputs and outputs, storing them in separate lists. Now we need to process these inputs and outputs into a format suitable for fine-tuning.\n\n\nCode\ndata = []\nfail = 0\ni = 0\n\nfor english_data, arabic_data in tqdm(zip(english, translations)):\n\n    try:\n        output_dict = convert_text_to_dict(arabic_data['response']['body']['choices'][0]['message']['content'])\n        ar_text = output_dict['ar']\n        eg_text = output_dict['eg']\n\n        en_text = english_data['body']['messages'][-1]['content'].split('Translate the following text:\\n')[-1]\n        \n        data.append({\"instruction\": \"Translate the following text to English.\",\n                    \"input\": ar_text,\n                    \"output\": en_text,\n                    \"input_lang\": \"ar\",\n                    \"output_lang\": \"en\",\n                    \"id\": i})\n        \n        data.append({\"instruction\": \"Translate the following text to English.\",\n                    \"input\": eg_text,\n                    \"output\": en_text,\n                    \"input_lang\": \"eg\",\n                    \"output_lang\": \"en\",\n                    \"id\": i})\n        \n        data.append({\"instruction\": \"Translate the following text to Arabic.\",\n                    \"input\": eg_text,\n                    \"output\": ar_text,\n                    \"input_lang\": \"eg\",\n                    \"output_lang\": \"ar\",\n                    \"id\": i})\n        \n        data.append({\"instruction\": \"Translate the following text to Arabic.\",\n                    \"input\": en_text,\n                    \"output\": ar_text,\n                    \"input_lang\": \"en\",\n                    \"output_lang\": \"ar\",\n                    \"id\": i})\n        \n        data.append({\"instruction\": \"Translate the following text to Egyptian Arabic.\",\n                    \"input\": ar_text,\n                    \"output\": eg_text,\n                    \"input_lang\": \"ar\",\n                    \"output_lang\": \"eg\",\n                    \"id\": i})\n        \n        data.append({\"instruction\": \"Translate the following text to Egyptian Arabic.\",\n                    \"input\": en_text,\n                    \"output\": eg_text,\n                    \"input_lang\": \"en\",\n                    \"output_lang\": \"eg\",\n                    \"id\": i})\n        \n        i += 1\n        \n    except:\n        fail += 1\n\n # Write jsonl file\nwith open(\"data/translation-dataset-openai-10k.jsonl\", 'w') as file:\n    for index in tqdm(range(0, len(data)), desc=\"Generating JSONL File\"):\n        row = data[index]\n        file.write(json.dumps(row) + '\\n')\n\n\nThis code processes each sample, creating six translation pairs for each, and writes them to a JSONL file suitable for fine-tuning.\nDue to some JSON parsing errors, the final dataset ended up with around 57K rows instead of 60K.\nThe next step is to split this dataset into training and testing sets to validate the performance of the model after fine-tuning.\nHere’s how you can split the dataset:\n\n\nCode\nimport random\n\nrandom.seed(42)\n\n# Path to your .jsonl file\ndataset_path = 'data/translation-dataset-openai-10k.jsonl'\ntrain_dataset_path = 'data/translation-dataset-openai-10k-train.jsonl'\ntest_dataset_path = 'data/translation-dataset-openai-10k-test.jsonl'\n\n# Initialize an empty list to store the data\ntrain_data_list = []\ntest_data_list = []\n\n# Open the file and read line by line\nwith open(dataset_path, 'r', encoding='utf-8') as file:\n\n    # Sample test ids\n    lines = file.readlines()\n    test_ids = random.sample(list(range(len(lines))), k=len(lines)//10)\n\n    for line in lines:\n        data = json.loads(line.strip())  # Parse JSON from each line\n        if data[\"id\"] in test_ids:\n            test_data_list.append(line)\n        else:\n            train_data_list.append(line)\n\ntrain_data_list = list([json.loads(l.strip()) for l in set(train_data_list)])\ntest_data_list = list([json.loads(l.strip()) for l in set(test_data_list)])\n\nwith open(train_dataset_path, 'w') as file:\n    for index in tqdm(range(0, len(train_data_list)), desc=\"Generating Train JSONL File\"):\n        row = train_data_list[index]\n        file.write(json.dumps(row) + '\\n')\n\nwith open(test_dataset_path, 'w') as file:\n    for index in tqdm(range(0, len(test_data_list)), desc=\"Generating Train JSONL File\"):\n        row = test_data_list[index]\n        file.write(json.dumps(row) + '\\n')\n\n\nAfter splitting the dataset, you can convert these JSONL files into HuggingFace datasets to make them easier to work with for fine-tuning:\n\nfrom datasets import Dataset\nimport pandas as pd\n\ntrain_dataset_df = pd.read_json(train_dataset_path, lines=True).astype(str)\ntest_dataset_df = pd.read_json(test_dataset_path, lines=True).astype(str)\n\ntrain_dataset = Dataset.from_pandas(train_dataset_df)\ntest_dataset = Dataset.from_pandas(test_dataset_df)\n\ntrain_dataset.save_to_disk('translation-dataset-v3-train.hf')\ntest_dataset.save_to_disk('translation-dataset-v3-test.hf')\n\nWith these steps, you now have the train and test datasets ready for fine-tuning and validating your model.\n\n\nFinetuning Llama 3 8B using Axolotl\nTo give you a brief intro about Axolotl, it is a tool designed to streamline LLM fine-tuning. I like Axolotl because it lets you focus on the data instead of the fine-tuning code, while incorporating the best fine-tuning practices.\nIn this project, I used a pretty simple finetuning configuration that I’ll provide below. To summarize what the configuration entails:\n\nIt loads a Llama 3 8B in 8bit\nIt uses the alpaca format for finetuning\nIt finetunes a LoRA adapter instead of doing a full finetune\nIt uses sample packing to improve finetuning efficiency\nIt trains the model for 2 epochs, while running 10 evals per epoch\nIt logs the train and eval loss into weights and biases\n\nThe finetuning was carried out on a single A5000 GPU (24 GB VRAM) on Jarvis Labs that costs 0.49$/hr, and took around 10 hours to complete. You can check the weights and biases log over here.\nFor more info about Axolotl, I highly recommend the documentation, and checking this short video guide by Jarvis Labs that shows how to spin up an instance that uses axolotl over there.\nbase_model: meta-llama/Meta-Llama-3-8B\nmodel_type: LlamaForCausalLM\ntokenizer_type: AutoTokenizer\n\nload_in_8bit: true\nload_in_4bit: false\nstrict: false\n\ndatasets:\n  - path: translation-dataset-v3-train.hf\n    type: alpaca\n    train_on_split: train\n\ntest_datasets:\n  - path: translation-dataset-v3-test.hf\n    type: alpaca\n    split: train\n\ndataset_prepared_path: ./last_run_prepared\noutput_dir: ./llama_3_translator\nhub_model_id: ahmedsamirio/llama_3_translator_v3\n\n\nsequence_len: 2048\nsample_packing: true\npad_to_sequence_len: true\neval_sample_packing: false\n\nadapter: lora\nlora_r: 32\nlora_alpha: 16\nlora_dropout: 0.05\nlora_target_linear: true\nlora_fan_in_fan_out:\nlora_target_modules:\n  - gate_proj\n  - down_proj\n  - up_proj\n  - q_proj\n  - v_proj\n  - k_proj\n  - o_proj\n\nwandb_project: en_eg_translator\nwandb_entity: ahmedsamirio\nwandb_name: llama_3_en_eg_translator_v3\n\ngradient_accumulation_steps: 4\nmicro_batch_size: 2\nnum_epochs: 2\noptimizer: paged_adamw_32bit\nlr_scheduler: cosine\nlearning_rate: 2e-5\n\ntrain_on_inputs: false\ngroup_by_length: false\nbf16: auto\nfp16:\ntf32: false\n\ngradient_checkpointing: true\nearly_stopping_patience:\nresume_from_checkpoint:\nlocal_rank:\nlogging_steps: 1\nxformers_attention:\nflash_attention: true\n\nwarmup_steps: 10\nevals_per_epoch: 10\neval_table_size:\neval_max_new_tokens: 128\nsaves_per_epoch: 1\ndebug:\ndeepspeed:\nweight_decay: 0.0\nfsdp:\nfsdp_config:\nspecial_tokens:\n  pad_token: &lt;|end_of_text|&gt;\n\n\nComparing the finetuned model with GPT-4o\nOf course, the comparison here will go in facor of GPT-4o, but since we were aiming to emulate it’s performance, let’s make a comparison to see how far off our finetuned model is.\nI’ll use three random sample responses from the Alpaca dataset.\n\n\nCode\nalpaca_sample = [\n    \"\"\"I had to make a difficult decision when I was working as a project manager at a construction company. I was in charge of a project that needed to be completed by a certain date in order to meet the client’s expectations. However, due to unexpected delays, we were not able to meet the deadline and so I had to make a difficult decision. I decided to extend the deadline, but I had to stretch the team’s resources even further and increase the budget. Although it was a risky decision, I ultimately decided to go ahead with it to ensure that the project was completed on time and that the client’s expectations were met. The project was eventually successfully completed and this was seen as a testament to my leadership and decision-making abilities.\"\"\",\n    \"\"\"There are several factors that contribute to an individual's success, such as hard work and dedication, effective communication skills, positive attitude, good time management, a clear vision and specific goals, problem-solving and decision-making skills, willingness to take risks, resilience and adaptability, prioritization and organization, proactivity, self-motivation, personal growth, and the ability to collaborate with others.\"\"\",\n    \"\"\"Cats and dogs are both beloved pets, but they have important differences. Dogs are typically more outgoing and energetic, while cats are considered more independent. Dogs tend to be more social and active, enjoying walks and playing with other animals. Cats, on the other hand, tend to be more solitary, preferring to relax and snuggle up in a warm spot. Dogs typically require more care and attention, while cats are more self-sufficient. Despite these differences, cats and dogs remain popular and loving pets.\"\"\"\n]\n\n\n\nfrom transformers import AutoTokenizer, AutoModelForCausalLM, pipeline\n\ntokenizer = AutoTokenizer.from_pretrained(\"ahmedsamirio/Egyptian-Arabic-Translator-Llama-3-8B\")\nmodel = AutoModelForCausalLM.from_pretrained(\"ahmedsamirio/Egyptian-Arabic-Translator-Llama-3-8B\", load_in_8bit=True, device_map=\"cuda\")\npipe = pipeline(task='text-generation', model=model, tokenizer=tokenizer)\n\n\n\nCode\nar_template = \"\"\"&lt;|begin_of_text|&gt;Below is an instruction that describes a task, paired with an input that provides further context. Write a response that appropriately completes the request.\n\n### Instruction:\nTranslate the following text to Arabic.\n\n### Input:\n{text}\n\n### Response:\n\"\"\"\n\neg_template = \"\"\"&lt;|begin_of_text|&gt;Below is an instruction that describes a task, paired with an input that provides further context. Write a response that appropriately completes the request.\n\n### Instruction:\nTranslate the following text to Egyptian Arabic.\n\n### Input:\n{text}\n\n### Response:\n\"\"\"\n\ndef get_output(prompt, max_new_tokens):\n    out = pipe(prompt, max_new_tokens=max_new_tokens, do_sample=False, temperature=None)\n    return out[0]['generated_text'].split(\"### Response:\\n\")[-1]\n\ndef get_ft_model_translations(text):\n    eg_text = get_output(eg_template.format(text=text), 512)\n    translations = {\"eg\": eg_text}\n    return translations\n\ndef get_gpt4o_translations(text):\n    response = client.chat.completions.create(\n      model=\"gpt-4o\",\n      messages=[{\"role\": \"system\", \"content\": SYSTEM_PROMPT}, \n                {\"role\": \"user\", \"content\": f\"Translate the following text:\\n{text}\"}],\n      temperature=1,\n      max_tokens=512,\n      top_p=1\n    )\n    translations = convert_text_to_dict(response.choices[0].message.content)\n    return translations\n\ndef compare_translations(text):\n    ft_translations = get_ft_model_translations(text)\n    gpt4o_translations = get_gpt4o_translations(text)\n    \n    print(\"Original Text:\\n\")\n    print(text)\n    print()\n    \n    print('GPT-4o Translation:\\n')\n    print(gpt4o_translations['eg'])\n    print()\n    \n    print('Fintuned Model Translation:\\n')\n    print(ft_translations['eg'])\n    print()\n\n\n\nSample 1\n\n\nCode\ncompare_translations(alpaca_sample[0])\n\n\nOriginal Text:\n\nI had to make a difficult decision when I was working as a project manager at a construction company. I was in charge of a project that needed to be completed by a certain date in order to meet the client’s expectations. However, due to unexpected delays, we were not able to meet the deadline and so I had to make a difficult decision. I decided to extend the deadline, but I had to stretch the team’s resources even further and increase the budget. Although it was a risky decision, I ultimately decided to go ahead with it to ensure that the project was completed on time and that the client’s expectations were met. The project was eventually successfully completed and this was seen as a testament to my leadership and decision-making abilities.\n\nGPT-4o Translation:\n\nاضطريت آخد قرار صعب وأنا كنت شغال كمدير مشروع في شركة مقاولات. كنت مسؤول عن مشروع لازم يخلص في معاد معين عشان نرضي العميل. بس بسبب تأخيرات غير متوقعة، ماقدرناش نلتزم بالميعاد، فكان لازم آخد قرار صعب. قررت أمد الميعاد، بس كان لازم أضغط على فريق العمل وأزود الميزانية. رغم إن القرار كان محفوف بالمخاطر، قررت أمشي فيه عشان المشروع يخلص في وقته ونرضي العميل. في الآخر، المشروع نجح وتنفذ بنجاح وده كان شهادة على قدراتي في القيادة واتخاذ القرارات.\n\nFintuned Model Translation:\n\nكان لازم أاخد قرار صعب لما كنت شغال كمدير مشروع في شركة بناء. كنت مسؤول عن مشروع كان محتاج يخلص في موعد معين عشان نوفر توقعات العميل. بس بسبب تأخيرات غير متوقعة، ما قدرتش نتوفر على الميعاد واضطرت أاخد قرار صعب. قررت أطول الميعاد، بس كان لازم أزود موارد الفريق أكتر وأزود الميزانية. رغم إن القرار كان محفوف بالمخاطر، قررت أتابع المهمة عشان أتأكد إن المشروع يخلص في الوقت المناسب وإن توقعات العميل تتحقق. المشروع خلص في النهاية بنجاح وده اتشاف كدليل على قيادتي وقدراتي في اتخاذ القرارات.\n\n\n\n\n\nSample 2\n\n\nCode\ncompare_translations(alpaca_sample[1])\n\n\nOriginal Text:\n\nThere are several factors that contribute to an individual's success, such as hard work and dedication, effective communication skills, positive attitude, good time management, a clear vision and specific goals, problem-solving and decision-making skills, willingness to take risks, resilience and adaptability, prioritization and organization, proactivity, self-motivation, personal growth, and the ability to collaborate with others.\n\nGPT-4o Translation:\n\nفي عوامل كتير بتساهم في نجاح الشخص، زي الشغل الجامد والاجتهاد، مهارات التواصل الفعّالة، النظرة الإيجابية، إدارة الوقت بشكل كويس، رؤية واضحة وأهداف محددة، مهارات حل المشاكل واتخاذ القرار، الرغبة في المخاطرة، المرونة والتكيف، الأولويات والتنظيم، المبادرة، التحفيز الذاتي، النمو الشخصي، والقدرة على التعاون مع الناس التانية.\n\nFintuned Model Translation:\n\nفيه عوامل كتير بتساهم في نجاح الشخص، زي الشغل الجاد والتفاني، مهارات التواصل الفعّالة، المزاج الإيجابي، إدارة الوقت بشكل كويس، رؤية واضحة وأهداف محددة، مهارات حل المشاكل واتخاذ القرارات، استعداد لتحمل المخاطر، الصمود والقدرة على التكيف، الترتيب والتنظيم، الإقدام، التحفيز الذاتي، النمو الشخصي، والقدرة على التعاون مع الآخرين.\n\n\n\n\n\nSample 3\n\n\nCode\ncompare_translations(alpaca_sample[2])\n\n\nOriginal Text:\n\nCats and dogs are both beloved pets, but they have important differences. Dogs are typically more outgoing and energetic, while cats are considered more independent. Dogs tend to be more social and active, enjoying walks and playing with other animals. Cats, on the other hand, tend to be more solitary, preferring to relax and snuggle up in a warm spot. Dogs typically require more care and attention, while cats are more self-sufficient. Despite these differences, cats and dogs remain popular and loving pets.\n\nGPT-4o Translation:\n\nالقطط والكلاب الحيوانات دي الاتنين محبوبين، بس في اختلافات مهمة بينهم. الكلاب عادةً بتكون أكثر انفتاح ونشاط، في حين إن القطط بتحب تستقل. الكلاب بتحب الاختلاط وبتكون نشيطة، بتمبسط من المشي واللعب مع الحيوانات التانية. لكن القطط بتميل للعزلة، وبتحب تسترخى وتتمدد في مكان دافئ. الكلاب بتطلب رعاية واهتمام أكتر، بس القطط بتعتمد على نفسها أكتر. رغم الاختلافات دي، القطط والكلاب لسه حيوانات أليفة محبوبة وشعبية.\n\nFintuned Model Translation:\n\nالقطط والكلاب هما حيوانات أليفة محبوبة، بس عندهم اختلافات مهمة. الكلاب عادةً بتكون أكتر نشاطًا وطاقة، والقطط بتعتبر أكتر استقلالية. الكلاب عادةً بتكون أكتر اجتماعية ونشطة، وبتستمتع بالمشي واللعب مع الحيوانات التانية. أما القطط، بتكون أكتر وحدة، وبتفضل تستريح وتدوس في مكان دافي. الكلاب عادةً محتاجة عناية أكتر، والقطط بتكون أكتر استقلالية. رغم الاختلافات دي، القطط والكلاب لسه حيوانات أليفة مشهورة ومحبوبة.\n\n\n\n\n\n\nConclusion\nAs you can see, the results are still not perfect. However, the fine-tuned model is starting to catch up with GPT-4o. With some minor adjustments to the fine-tuning methodology, I believe we can achieve performance closer to that of GPT-4o.\nIn conclusion, this project demonstrates the potential of fine-tuning large language models to effectively translate English to Egyptian Arabic, addressing a significant gap in existing resources. While the fine-tuned model is not yet on par with GPT-4o, it shows promising results and opens up opportunities for further improvement. By refining the fine-tuning process and expanding the dataset, we can continue to enhance the model’s performance. I hope this walkthrough provides valuable insights and inspires others to explore and contribute to this area. Thank you for following along, and I look forward to sharing more updates as this project progresses.\n\n\nTL;DR\n\nUsed GPT-4o to create translation pairs from English to Modern Standard Arabic and then to Egyptian Arabic.\nGenerated a dataset from the OpenAssistant/oasst2 messages using GPT-4o and OpenAI’s batch API.\nPrepared and processed the dataset for fine-tuning.\nFine-tuned Llama-3-8B using Axolotl, focusing on LoRA adapters and sample packing.\nEvaluated the fine-tuned model against GPT-4o using sample texts.\nFound that while the fine-tuned model isn’t perfect, it’s a significant step towards accessible Egyptian Arabic translations."
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "Hi, I’m Ahmed Samir, a Data Scientist.\nI’m currently interested in LLM Applications, and will be sharing the things I’m currently learning in this blog."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "blog",
    "section": "",
    "text": "Finetuing an Egyptian Arabic Translator\n\n\n\n\n\n\n\n\n\n\n\nJul 20, 2024\n\n\nAhmed Samir\n\n\n\n\n\n\nNo matching items"
  }
]